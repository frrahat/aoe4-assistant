<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Streamer</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f4f4f4; }
        .container { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; align-items: center; }
        .image-container { position: relative; }
        img { max-width: 100%; max-height: 80vh; border-radius: 8px; box-shadow: 0 2px 8px #0002; }
        .error { color: red; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <label>Width: <input type="number" id="width" min="10" max="1000" required></label>
            <label>Height: <input type="number" id="height" min="10" max="1000" required></label>
            <label>X Position: <input type="number" id="x" min="0" max="10000" required></label>
            <label>Y Position: <input type="number" id="y" min="0" max="50000" required></label>
        </div>
        <div id="error-message" class="error" style="display:none;"></div>
        <div class="image-container">
            <img id="stream-img" src="" alt="Streaming...">
        </div>
        <div class="controls">
            <label>Description (optional): <input type="text" id="description" placeholder="Enter description..." maxlength="50"></label>
            <button id="capture-btn" style="padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Capture</button>
        </div>
    </div>
    <script>
        const widthInput = document.getElementById('width');
        const heightInput = document.getElementById('height');
        const xInput = document.getElementById('x');
        const yInput = document.getElementById('y');
        const img = document.getElementById('stream-img');
        const errorMessage = document.getElementById('error-message');
        const captureBtn = document.getElementById('capture-btn');
        const descriptionInput = document.getElementById('description');
        let intervalId = null;

        async function updateConfig() {
            const width = parseInt(widthInput.value);
            const height = parseInt(heightInput.value);
            const x = parseInt(xInput.value);
            const y = parseInt(yInput.value);
            
            try {
                const response = await fetch('/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ width, height, x, y })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    errorMessage.style.display = 'none';
                } else {
                    errorMessage.textContent = result.error || 'Failed to update config';
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                errorMessage.textContent = 'Network error: ' + error.message;
                errorMessage.style.display = 'block';
            }
        }

        widthInput.onchange = updateConfig;
        heightInput.onchange = updateConfig;
        xInput.onchange = updateConfig;
        yInput.onchange = updateConfig;

        async function captureImage() {
            const width = parseInt(widthInput.value);
            const height = parseInt(heightInput.value);
            const x = parseInt(xInput.value);
            const y = parseInt(yInput.value);
            const description = descriptionInput.value.trim();
            
            try {
                const response = await fetch('/capture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ width, height, x, y, description })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    errorMessage.textContent = 'Image captured successfully!';
                    errorMessage.style.color = 'green';
                    errorMessage.style.display = 'block';
                    setTimeout(() => {
                        errorMessage.style.display = 'none';
                    }, 3000);
                } else {
                    errorMessage.textContent = result.error || 'Failed to capture image';
                    errorMessage.style.color = 'red';
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                errorMessage.textContent = 'Network error: ' + error.message;
                errorMessage.style.color = 'red';
                errorMessage.style.display = 'block';
            }
        }

        captureBtn.onclick = captureImage;

        // Load current config on page load
        async function loadConfig() {
            try {
                const response = await fetch('/config');
                const config = await response.json();
                widthInput.value = config.width;
                heightInput.value = config.height;
                xInput.value = config.x;
                yInput.value = config.y;
            } catch (error) {
                console.error('Failed to load config, using default values:', error);
                widthInput.value = 300;
                heightInput.value = 200;
                xInput.value = 11;
                yInput.value = 733;
            }
        }

        function startPolling() {
            fetchAndUpdate();
            intervalId = setInterval(fetchAndUpdate, 2000);
        }
        
        function fetchAndUpdate() {
            // Add a cache buster to avoid browser caching
            img.src = `/latest-image?_=${Date.now()}`;
        }

        (async () => {
            await loadConfig();
            await updateConfig(); // Post initial (default or loaded) config
            startPolling();
        })();
    </script>
</body>
</html> 